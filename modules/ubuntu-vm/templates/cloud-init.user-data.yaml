#cloud-config
hostname: ${hostname}
fqdn: ${hostname}.local
manage_etc_hosts: true

users:
  - name: ${automation_user}
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: sudo
    lock_passwd: true
    ssh-authorized-keys:
      - "${automation_user_pubkey}"

ssh_pwauth: false

chpasswd:
  expire: false
  users:
    - name: ${console_user}
      password: ${console_password}
      type: text

package_update: true
pakage_upgrade: true
packages:
  - git
  - curl
  - qemu-guest-agent
  - avahi-daemon
  - avahi-utils
  - libnss-mdns

power_state:
  mode: reboot
  message: System restart required
  timeout: 300
  condition: true

runcmd:
  - echo "net.ipv6.conf.all.disable_ipv6 = 1" >> /etc/sysctl.d/60-ipv6disable.conf
  - echo "net.ipv6.conf.default.disable_ipv6 = 1" >> /etc/sysctl.d/60-ipv6disable.conf
  - echo "net.ipv6.conf.lo.disable_ipv6 = 1" >> /etc/sysctl.d/60-ipv6disable.conf
  - sysctl -p
  - sed -i 's/^GRUB_CMDLINE_LINUX=.*/GRUB_CMDLINE_LINUX="mitigations=off ipv6.disable=1"/g' /etc/default/grub # my pip install takes forever over ipv6; could be buggy hw nic
  - update-grub
  - bash /tmp/launch_script.sh

%{ if length(launch_script) > 0 ~}
write_files:
  - path: /tmp/launch_script.sh
    owner: root:root
    permissions: 0o744
    content: |-
      ${indent(6, launch_script)}

%{~ endif ~}
